name: üì± Build & Sign ErudaBrowser APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      JAVA_TOOL_OPTIONS: "-Xmx2g"

    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node & Cordova
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: üì¶ Install Cordova & Dependencies
        run: |
          npm install -g cordova
          cd cordova_project
          npm install

      - name: üß± Add Android Platform (if not added)
        run: |
          cd cordova_project
          cordova platform ls | grep android || cordova platform add android

      - name: üèóÔ∏è Build Android APK (Release)
        run: |
          cd cordova_project
          cordova build android --release --no-interactive

      - name: üîç Find Unsigned APK
        id: find_apk
        run: |
          APK_PATH=$(find cordova_project/platforms/android/app/build/outputs/apk/release -name "*release-unsigned.apk" | head -n 1)
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
          echo "‚úÖ Found APK: $APK_PATH"

      - name: üîê Sign APK
        run: |
          jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
            -keystore release-key.jks \
            -storepass ${{ secrets.KEYSTORE_PASSWORD }} \
            -keypass ${{ secrets.KEY_PASSWORD }} \
            "$APK_PATH" ${{ secrets.KEY_ALIAS }}

      - name: üßæ Align APK
        run: |
          ZIPALIGN_PATH=$ANDROID_HOME/build-tools/*/zipalign
          ZIPALIGN=$(ls $ZIPALIGN_PATH | head -n 1)
          $ZIPALIGN -v 4 "$APK_PATH" ErudaBrowser.apk

      - name: üì§ Upload Final APK
        uses: actions/upload-artifact@v4
        with:
          name: ErudaBrowser
          path: ErudaBrowser.apk
