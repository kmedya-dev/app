name: 📱 Build ErudaBrowser APK

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: ☕ Set up Python & Node.js
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: 📦 Install Dependencies
        run: |
          pip install beautifulsoup4 lxml
          npm install -g cordova@7

      - name: 📥 Set up Android SDK
        run: |
          set -xe
          export ANDROID_SDK_ROOT="/usr/local/lib/android/sdk"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV

          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          cd "$ANDROID_SDK_ROOT/cmdline-tools"
          wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O tools.zip
          unzip -q tools.zip -d temp
          mv temp/cmdline-tools ./latest
          rm -rf temp tools.zip

          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/build-tools/33.0.2" >> $GITHUB_PATH

      - name: ✅ Install Android SDK Packages
        run: |
          set -xe
          yes | sdkmanager --licenses > /dev/null
          sdkmanager "platforms;android-33" "build-tools;33.0.2" "platform-tools" > /dev/null

      - name: 🔎 Load Build Variables
        id: vars
        run: |
          echo "APP_NAME=$(python -c 'from build import APP_NAME; print(APP_NAME)')" >> $GITHUB_OUTPUT
          echo "PACKAGE_NAME=$(python -c 'from build import PACKAGE_NAME; print(PACKAGE_NAME)')" >> $GITHUB_OUTPUT
          echo "VERSION_CODE=$(python -c 'from build import VERSION_CODE; print(VERSION_CODE)')" >> $GITHUB_OUTPUT
          echo "VERSION_NAME=$(python -c 'from build import VERSION_NAME; print(VERSION_NAME)')" >> $GITHUB_OUTPUT
          echo "ICON_PATH=$(python -c 'from build import ICON_PATH; print(ICON_PATH)')" >> $GITHUB_OUTPUT
          echo "WEB_ASSETS_PATH=$(python -c 'from build import WEB_ASSETS_PATH; print(WEB_ASSETS_PATH)')" >> $GITHUB_OUTPUT

      - name: 📂 Create Cordova Project
        run: |
          set -xe
          cordova create cordova_project ${{ steps.vars.outputs.PACKAGE_NAME }} "${{ steps.vars.outputs.APP_NAME }}"
          cd cordova_project
          cordova platform add android@12
          cp -r ../${{ steps.vars.outputs.WEB_ASSETS_PATH }}/* www/
          mkdir -p res/icon/android
          cp ../${{ steps.vars.outputs.ICON_PATH }} res/icon/android/icon-512x512.png

      - name: ⚙️ Create local.properties
        run: echo "sdk.dir=$ANDROID_SDK_ROOT" > cordova_project/platforms/android/local.properties

      - name: 🔧 Update Cordova Config
        run: python update_config.py
        env:
          VERSION_NAME: ${{ steps.vars.outputs.VERSION_NAME }}
          VERSION_CODE: ${{ steps.vars.outputs.VERSION_CODE }}

      - name: 🧱 Build Unsigned APK
        run: |
          set -xe
          cordova build android --release --verbose
        working-directory: ./cordova_project

      - name: 🔍 List APKs for Debug
        run: find cordova_project/platforms/android -name "*.apk" || echo "No APKs found"

      - name: 🔐 Sign APK
        id: sign_apk
        run: |
          set -xe
          KEYSTORE_PATH=${{ github.workspace }}/release.keystore
          echo "${{ secrets.SIGNING_KEY_BASE64 }}" | base64 --decode > "$KEYSTORE_PATH"

          echo "🔍 Searching for unsigned APK..."
          APK_DIR="${{ github.workspace }}/cordova_project/platforms/android"
          ALL_APKS=$(find "$APK_DIR" -type f -name "*release*.apk")
          echo "📦 Found APKs:"
          echo "$ALL_APKS"

          UNSIGNED_APK=$(echo "$ALL_APKS" | grep 'unsigned.apk' | head -n 1)

          if [ -z "$UNSIGNED_APK" ]; then
            echo "❌ Error: No unsigned APK found."
            find "$APK_DIR" -type f
            exit 1
          fi

          echo "✅ Unsigned APK path: $UNSIGNED_APK"

          SIGNED_APK_DIR=$(dirname "$UNSIGNED_APK")
          APP_NAME_VERSION="${{ steps.vars.outputs.APP_NAME }}-${{ steps.vars.outputs.VERSION_NAME }}"
          SIGNED_APK_PATH="$SIGNED_APK_DIR/$APP_NAME_VERSION.apk"

          apksigner sign \
            --ks "$KEYSTORE_PATH" \
            --ks-key-alias "${{ secrets.ALIAS }}" \
            --ks-pass "pass:${{ secrets.KEY_STORE_PASSWORD }}" \
            --key-pass "pass:${{ secrets.KEY_PASSWORD }}" \
            --out "$SIGNED_APK_PATH" \
            "$UNSIGNED_APK"

          apksigner verify "$SIGNED_APK_PATH"
          echo "signedReleaseFile=$SIGNED_APK_PATH" >> $GITHUB_OUTPUT

      - name: 📤 Upload Signed APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.vars.outputs.APP_NAME }}-${{ steps.vars.outputs.VERSION_NAME }}.apk
          path: ${{ steps.sign_apk.outputs.signedReleaseFile }}
